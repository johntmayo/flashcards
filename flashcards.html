<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Study App</title>
    <style>
        :root {
            --primary-bg: #f5f2eb;
            --card-bg: #fcfaf5;
            --text-color: #3c3c3c;
            --accent-primary: #a08f78;
            --accent-secondary: #7d6b5d;
            --button-bg: #9d8974;
            --button-hover: #8a7663;
            --card-border: #2c2c2c;
            --stroke-width: 3px;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #ebe6d8 100%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        h1 {
            color: var(--accent-secondary);
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: -1px;
        }

        .subtitle {
            color: var(--accent-primary);
            font-size: 1.1rem;
            margin: 0;
        }

        .app-controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }

        .category-filter select {
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid var(--accent-primary);
            background-color: var(--card-bg);
            font-size: 16px;
            color: var(--text-color);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .category-filter select:focus {
            outline: none;
            border-color: var(--accent-secondary);
        }

        .flashcard-area {
            height: 450px;
            perspective: 1200px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flashcard {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background-color: var(--card-bg);
            border-radius: 20px;
            border: var(--stroke-width) solid var(--card-border);
            font-size: 24px;
            text-align: center;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .card-content {
            max-width: 100%;
            max-height: 100%;
            overflow-y: auto;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .nav-button {
            background: linear-gradient(135deg, var(--button-bg) 0%, var(--accent-secondary) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-button:active {
            transform: translateY(0);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .control-button:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.6);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .progress-bar-container {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .data-connection {
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }

        .connection-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--accent-primary);
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            background-color: var(--card-bg);
        }

        .connection-input:focus {
            outline: none;
            border-color: var(--accent-secondary);
        }

        .sample-data-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--accent-primary);
        }

        .spreadsheet-example {
            font-family: 'Courier New', monospace;
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            border-left: 4px solid var(--accent-primary);
        }

        .instructions {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .instructions h4 {
            margin-top: 0;
            color: #2980b9;
        }

        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        /* Category color themes */
        .Science { background: linear-gradient(135deg, #d7e4c0 0%, #c9d6b5 100%); }
        .History { background: linear-gradient(135deg, #e4d1c0 0%, #d6c3b5 100%); }
        .Math { background: linear-gradient(135deg, #c0d1e4 0%, #b5c3d6 100%); }
        .Literature { background: linear-gradient(135deg, #e4c0dd 0%, #d6b5d0 100%); }
        .Language { background: linear-gradient(135deg, #c0e4e4 0%, #b5d6d6 100%); }
        .Culture { background: linear-gradient(135deg, #e4e4c0 0%, #d6d6b5 100%); }
        .Geography { background: linear-gradient(135deg, #c0c0e4 0%, #b5b5d6 100%); }
        .Other { background: linear-gradient(135deg, #d9d9d9 0%, #cccccc 100%); }

        .flip-hint {
            position: absolute;
            bottom: 15px;
            right: 20px;
            font-size: 12px;
            color: var(--accent-primary);
            opacity: 0.7;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .app-controls {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .card-face {
                font-size: 20px;
                padding: 30px 20px;
            }
            
            .flashcard-area {
                height: 400px;
            }
            
            h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .card-face {
                font-size: 18px;
                padding: 25px 15px;
            }
            
            .flashcard-area {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Flashcard Study App</h1>
            <p class="subtitle">Learn smarter with spaced repetition</p>
        </header>

        <div class="app-controls">
            <div class="category-filter">
                <select id="categorySelect">
                    <option value="all">All Categories</option>
                </select>
            </div>
            <button class="control-button" id="shuffleBtn">Shuffle</button>
            <button class="control-button" id="resetBtn">Reset Progress</button>
            <button class="control-button" id="settingsBtn" style="background: var(--accent-secondary);">Settings</button>
        </div>

        <div class="flashcard-area">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front">
                    <div class="card-content" id="cardFront">
                        Click "Load Sample Data" below to get started!
                    </div>
                    <div class="flip-hint">Click to flip</div>
                </div>
                <div class="card-face card-back">
                    <div class="card-content" id="cardBack">
                        Welcome to your flashcard app!
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-button" id="prevBtn">← Previous</button>
            <button class="nav-button" id="nextBtn">Next →</button>
        </div>

        <div class="progress-section">
            <div class="progress-stats">
                <span>Card <span id="currentIndex">0</span> of <span id="totalCards">0</span></span>
                <span><span id="viewedCount">0</span> cards studied</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
        </div>

        <div class="data-connection">
            <h2>Connect Your Data</h2>
            <p>Connect to a Google Spreadsheet with columns: <strong>Front</strong>, <strong>Back</strong>, <strong>Category</strong></p>
            
            <div class="instructions">
                <h4>Setup Instructions:</h4>
                <ol>
                    <li>Open your Google Spreadsheet</li>
                    <li>Click <strong>File → Share → Publish to web</strong></li>
                    <li>Select <strong>"Entire Document"</strong> and <strong>"Comma-separated values (.csv)"</strong></li>
                    <li>Click <strong>"Publish"</strong></li>
                    <li>Copy the spreadsheet ID from your URL (the long string between /d/ and /edit)</li>
                    <li>Paste it below</li>
                </ol>
            </div>

            <div class="spreadsheet-example">
| Front | Back | Category |
|-------|------|----------|
| What is photosynthesis? | Process plants use to convert light into energy | Science |
| Who wrote Hamlet? | William Shakespeare | Literature |
            </div>

            <input type="text" id="spreadsheetId" class="connection-input" 
                   placeholder="Paste your Google Spreadsheet ID here (e.g., 1A2B3C4D5E6F...)">
            <button class="nav-button" id="connectBtn">Connect Spreadsheet</button>

            <div class="sample-data-section">
                <h3>Try Sample Data</h3>
                <p>Test the app with pre-loaded perfume facts:</p>
                <button class="nav-button" id="loadSampleBtn" style="background: var(--accent-primary);">
                    Load Sample Perfume Facts
                </button>
            </div>
        </div>
    </div>

    <script>
        class FlashcardApp {
            constructor() {
                this.flashcards = [];
                this.currentIndex = 0;
                this.viewedCards = new Set();
                this.categories = new Set();
                this.filteredCards = [];
                this.currentCategory = 'all';
                this.isFlipped = false;
                
                this.initializeElements();
                this.attachEventListeners();
                this.loadSavedData();
            }

            initializeElements() {
                this.elements = {
                    flashcard: document.getElementById('flashcard'),
                    cardFront: document.getElementById('cardFront'),
                    cardBack: document.getElementById('cardBack'),
                    prevBtn: document.getElementById('prevBtn'),
                    nextBtn: document.getElementById('nextBtn'),
                    shuffleBtn: document.getElementById('shuffleBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    categorySelect: document.getElementById('categorySelect'),
                    connectBtn: document.getElementById('connectBtn'),
                    loadSampleBtn: document.getElementById('loadSampleBtn'),
                    spreadsheetId: document.getElementById('spreadsheetId'),
                    currentIndex: document.getElementById('currentIndex'),
                    totalCards: document.getElementById('totalCards'),
                    viewedCount: document.getElementById('viewedCount'),
                    progressBar: document.getElementById('progressBar')
                };
            }

            attachEventListeners() {
                this.elements.flashcard.addEventListener('click', () => this.flipCard());
                this.elements.prevBtn.addEventListener('click', () => this.previousCard());
                this.elements.nextBtn.addEventListener('click', () => this.nextCard());
                this.elements.shuffleBtn.addEventListener('click', () => this.shuffleCards());
                this.elements.resetBtn.addEventListener('click', () => this.resetProgress());
                this.elements.categorySelect.addEventListener('change', () => this.filterByCategory());
                this.elements.connectBtn.addEventListener('click', () => this.connectSpreadsheet());
                this.elements.loadSampleBtn.addEventListener('click', () => this.loadSampleData());

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.flipCard();
                    } else if (e.code === 'ArrowLeft') {
                        this.previousCard();
                    } else if (e.code === 'ArrowRight') {
                        this.nextCard();
                    }
                });
            }

            loadSavedData() {
                // Use variables instead of localStorage in this environment
                this.savedProgress = this.savedProgress || new Set();
                this.savedSpreadsheetId = this.savedSpreadsheetId || '';
                
                this.viewedCards = this.savedProgress;
                if (this.savedSpreadsheetId) {
                    this.elements.spreadsheetId.value = this.savedSpreadsheetId;
                }
            }

            loadSampleData() {
                this.flashcards = [
                    { front: "What is the oldest known perfumery?", back: "The Pyrgos-Mavroraki in Cyprus, dating back 4,000 years, is considered the oldest discovered perfume factory.", category: "History" },
                    { front: "What does 'perfume' literally mean?", back: "The word 'perfume' comes from Latin 'per fumum' meaning 'through smoke,' referring to the original method of releasing fragrant smoke from burning materials.", category: "Language" },
                    { front: "What are the primary fragrance families?", back: "The main fragrance families are Floral, Oriental, Woody, and Fresh, with numerous subfamilies within each.", category: "Science" },
                    { front: "What is a 'perfumer' professionally called?", back: "A professional perfume creator is called a 'Nose' (Nez in French) due to their highly trained sense of smell.", category: "Culture" },
                    { front: "What determines how long a perfume lasts on skin?", back: "The concentration of aromatic compounds (essential oils) determines longevity - perfume (15-30%) lasts longest, followed by eau de parfum (15-20%), eau de toilette (5-15%), and eau de cologne (2-4%).", category: "Science" },
                    { front: "What is 'sillage' in perfumery?", back: "Sillage (pronounced 'see-yazh') is a French term describing the scent trail left by perfume - how far it projects from the wearer.", category: "Language" },
                    { front: "What is ambergris and why is it valuable in perfumery?", back: "Ambergris is a solid waxy substance produced in the digestive system of sperm whales. It's highly valued in perfumery for its sweet, earthy scent and ability to make fragrances last longer.", category: "Science" },
                    { front: "What distinguished Chanel No. 5 when it debuted in 1921?", back: "Chanel No. 5 was revolutionary for using aldehydes (synthetic components) in fine fragrance, breaking the tradition of using only natural ingredients and creating the first truly 'modern' perfume.", category: "History" },
                    { front: "What is a 'dupe' in the perfume community?", back: "A 'dupe' is a less expensive fragrance that smells very similar to a more expensive, often designer, perfume.", category: "Culture" },
                    { front: "How many scents can the human nose distinguish?", back: "The human nose can distinguish between approximately 1 trillion different scents, far more than previously thought.", category: "Science" }
                ];
                
                this.processData();
                this.showNotification("Sample perfume facts loaded successfully!");
            }

            extractSpreadsheetId(input) {
                // Clean the input
                const cleanInput = input.trim();
                
                // If it's already just an ID (alphanumeric with some symbols)
                if (/^[a-zA-Z0-9_-]{20,}$/.test(cleanInput)) {
                    return cleanInput;
                }
                
                // Extract from full URL
                const urlMatch = cleanInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (urlMatch) {
                    return urlMatch[1];
                }
                
                // Extract from sharing link
                const shareMatch = cleanInput.match(/id=([a-zA-Z0-9-_]+)/);
                if (shareMatch) {
                    return shareMatch[1];
                }
                
                return cleanInput; // Return as-is if no pattern matches
            }

            async connectSpreadsheet() {
                const input = this.elements.spreadsheetId.value.trim();
                
                if (!input) {
                    this.showNotification("Please enter a valid spreadsheet ID or URL", "error");
                    return;
                }

                const spreadsheetId = this.extractSpreadsheetId(input);
                this.savedSpreadsheetId = spreadsheetId;
                
                // Check if running locally
                const isLocal = window.location.protocol === 'file:' || 
                               window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
                
                if (isLocal) {
                    this.showLocalFileWarning(spreadsheetId);
                    return;
                }
                
                // Show loading state
                const originalText = this.elements.connectBtn.textContent;
                this.elements.connectBtn.textContent = "Connecting...";
                this.elements.connectBtn.disabled = true;
                
                try {
                    // Construct the CSV export URL
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=0`;
                    
                    // Use fetch with timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const response = await fetch(csvUrl, {
                        method: 'GET',
                        signal: controller.signal,
                        mode: 'cors'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const csvData = await response.text();
                    
                    if (!csvData || csvData.trim().length === 0) {
                        throw new Error("The spreadsheet appears to be empty");
                    }
                    
                    this.parseCSVData(csvData);
                    this.showNotification("Spreadsheet connected successfully!");
                    
                } catch (error) {
                    console.error("Connection error:", error);
                    
                    let errorMessage = "Error connecting to spreadsheet. ";
                    
                    if (error.name === 'AbortError') {
                        errorMessage += "Connection timed out.";
                    } else if (error.message.includes('HTTP 404')) {
                        errorMessage += "Spreadsheet not found. Check the ID and make sure it's published.";
                    } else if (error.message.includes('HTTP 403')) {
                        errorMessage += "Access denied. Make sure the spreadsheet is published to the web.";
                    } else if (error.message.includes('CORS') || error.message.includes('fetch')) {
                        errorMessage = "CORS Error: Cannot connect to Google Sheets from a local file. Please host this file on a web server or use the manual CSV method below.";
                    } else {
                        errorMessage += error.message || "Please check that the spreadsheet is published to the web as CSV.";
                    }
                    
                    this.showNotification(errorMessage, "error");
                } finally {
                    // Reset button state
                    this.elements.connectBtn.textContent = originalText;
                    this.elements.connectBtn.disabled = false;
                }
            }

            showLocalFileWarning(spreadsheetId) {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=0`;
                
                // Create a modal-like notification
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    box-sizing: border-box;
                `;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin-top: 0; color: #e74c3c;">Local File Limitation</h3>
                    <p>Since you're running this from a local file, browsers block connections to Google Sheets for security reasons.</p>
                    
                    <h4>Manual Solution:</h4>
                    <ol style="text-align: left; margin: 15px 0;">
                        <li>Click the link below to download your spreadsheet as CSV</li>
                        <li>Open the downloaded CSV file in a text editor</li>
                        <li>Copy all the content</li>
                        <li>Paste it in the text area that will appear</li>
                    </ol>
                    
                    <a href="${csvUrl}" target="_blank" style="
                        display: inline-block;
                        background: #3498db;
                        color: white;
                        padding: 10px 20px;
                        text-decoration: none;
                        border-radius: 8px;
                        margin: 10px 5px;
                    ">Download CSV</a>
                    
                    <button id="showPasteArea" style="
                        background: #27ae60;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        margin: 10px 5px;
                        cursor: pointer;
                    ">I have the CSV data</button>
                    
                    <button id="closeModal" style="
                        background: #95a5a6;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        margin: 10px 5px;
                        cursor: pointer;
                    ">Cancel</button>
                `;
                
                modal.appendChild(dialog);
                document.body.appendChild(modal);
                
                // Event listeners
                document.getElementById('closeModal').onclick = () => {
                    document.body.removeChild(modal);
                };
                
                document.getElementById('showPasteArea').onclick = () => {
                    document.body.removeChild(modal);
                    this.showCSVPasteArea();
                };
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            }

            showCSVPasteArea() {
                // Create paste area
                const pasteModal = document.createElement('div');
                pasteModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    box-sizing: border-box;
                `;
                
                const pasteDialog = document.createElement('div');
                pasteDialog.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    width: 90%;
                    max-width: 700px;
                    max-height: 80vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                `;
                
                pasteDialog.innerHTML = `
                    <h3 style="margin-top: 0;">Paste Your CSV Data</h3>
                    <p>Paste the entire contents of your CSV file here:</p>
                    <textarea id="csvPasteArea" style="
                        width: 100%;
                        height: 300px;
                        font-family: monospace;
                        font-size: 12px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        padding: 10px;
                        resize: vertical;
                        box-sizing: border-box;
                    " placeholder="Front,Back,Category
What is 2+2?,Four,Math
Capital of France?,Paris,Geography"></textarea>
                    <div style="margin-top: 15px;">
                        <button id="processCsv" style="
                            background: #27ae60;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            margin-right: 10px;
                            cursor: pointer;
                            font-size: 16px;
                        ">Load Flashcards</button>
                        <button id="cancelPaste" style="
                            background: #95a5a6;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                        ">Cancel</button>
                    </div>
                `;
                
                pasteModal.appendChild(pasteDialog);
                document.body.appendChild(pasteModal);
                
                // Focus the textarea
                setTimeout(() => {
                    document.getElementById('csvPasteArea').focus();
                }, 100);
                
                // Event listeners
                document.getElementById('cancelPaste').onclick = () => {
                    document.body.removeChild(pasteModal);
                };
                
                document.getElementById('processCsv').onclick = () => {
                    const csvData = document.getElementById('csvPasteArea').value.trim();
                    if (!csvData) {
                        this.showNotification("Please paste some CSV data", "error");
                        return;
                    }
                    
                    try {
                        this.parseCSVData(csvData);
                        document.body.removeChild(pasteModal);
                        this.showNotification("CSV data loaded successfully!");
                    } catch (error) {
                        this.showNotification(`Error parsing CSV: ${error.message}`, "error");
                    }
                };
                
                pasteModal.onclick = (e) => {
                    if (e.target === pasteModal) {
                        document.body.removeChild(pasteModal);
                    }
                };
            }

            parseCSVData(csvData) {
                try {
                    const lines = csvData.split(/\r?\n/).filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        throw new Error("Spreadsheet must have at least a header row and one data row");
                    }

                    // Parse header row
                    const headers = this.parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
                    console.log("Headers found:", headers);
                    
                    // Find required columns (case-insensitive)
                    const frontIndex = headers.findIndex(h => h.includes('front') || h.includes('question'));
                    const backIndex = headers.findIndex(h => h.includes('back') || h.includes('answer'));
                    const categoryIndex = headers.findIndex(h => h.includes('category') || h.includes('type') || h.includes('subject'));

                    if (frontIndex === -1) {
                        throw new Error("Could not find 'Front' or 'Question' column in spreadsheet");
                    }
                    
                    if (backIndex === -1) {
                        throw new Error("Could not find 'Back' or 'Answer' column in spreadsheet");
                    }

                    this.flashcards = [];
                    let validCards = 0;
                    let skippedCards = 0;
                    
                    // Parse data rows
                    for (let i = 1; i < lines.length; i++) {
                        try {
                            const values = this.parseCSVLine(lines[i]);
                            
                            if (values.length <= Math.max(frontIndex, backIndex)) {
                                skippedCards++;
                                continue;
                            }

                            const front = values[frontIndex]?.trim() || '';
                            const back = values[backIndex]?.trim() || '';
                            const category = categoryIndex !== -1 && values[categoryIndex] ? 
                                           values[categoryIndex].trim() : 'Other';
                            
                            if (front && back) {
                                this.flashcards.push({ front, back, category });
                                validCards++;
                            } else {
                                skippedCards++;
                            }
                        } catch (rowError) {
                            console.warn(`Error parsing row ${i + 1}:`, rowError);
                            skippedCards++;
                        }
                    }

                    if (this.flashcards.length === 0) {
                        throw new Error("No valid flashcards found. Make sure your Front and Back columns contain data.");
                    }

                    console.log(`Loaded ${validCards} cards, skipped ${skippedCards} empty/invalid rows`);
                    this.processData();
                    
                } catch (error) {
                    console.error("CSV parsing error:", error);
                    throw new Error(`Failed to parse spreadsheet data: ${error.message}`);
                }
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                let i = 0;
                
                while (i < line.length) {
                    const char = line[i];
                    
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            // Escaped quote
                            current += '"';
                            i += 2;
                        } else {
                            // Toggle quote state
                            inQuotes = !inQuotes;
                            i++;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // Field separator
                        result.push(current);
                        current = '';
                        i++;
                    } else {
                        current += char;
                        i++;
                    }
                }
                
                result.push(current);
                return result;
            }

            processData() {
                this.categories = new Set(this.flashcards.map(card => card.category));
                this.updateCategoryFilter();
                this.filterByCategory();
                this.currentIndex = 0;
                this.showCard();
            }

            updateCategoryFilter() {
                const select = this.elements.categorySelect;
                const currentValue = select.value;
                select.innerHTML = '<option value="all">All Categories</option>';
                
                Array.from(this.categories).sort().forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
                
                // Restore selection if it still exists
                if ([...this.categories].includes(currentValue) || currentValue === 'all') {
                    select.value = currentValue;
                }
            }

            filterByCategory() {
                const selectedCategory = this.elements.categorySelect.value;
                
                if (selectedCategory === 'all') {
                    this.filteredCards = [...this.flashcards];
                } else {
                    this.filteredCards = this.flashcards.filter(card => card.category === selectedCategory);
                }
                
                this.currentIndex = 0;
                this.showCard();
                this.updateProgress();
            }

            showCard() {
                if (this.filteredCards.length === 0) {
                    this.elements.cardFront.textContent = "No cards available";
                    this.elements.cardBack.textContent = "Add some flashcards to get started!";
                    this.updateNavigationButtons();
                    return;
                }

                const card = this.filteredCards[this.currentIndex];
                
                // Reset flip state
                this.elements.flashcard.classList.remove('flipped');
                this.isFlipped = false;
                
                // Update content
                this.elements.cardFront.textContent = card.front;
                this.elements.cardBack.textContent = card.back;
                
                // Apply category styling
                this.updateCardStyling(card.category);
                
                // Mark as viewed
                this.viewedCards.add(card.front);
                this.saveProgress();
                
                this.updateNavigationButtons();
                this.updateProgress();
            }

            updateCardStyling(category) {
                const cardFaces = [this.elements.cardFront.parentElement, this.elements.cardBack.parentElement];
                const categoryClasses = ['Science', 'History', 'Math', 'Literature', 'Language', 'Culture', 'Geography', 'Other'];
                
                cardFaces.forEach(face => {
                    categoryClasses.forEach(cls => face.classList.remove(cls));
                    face.classList.add(category);
                });
            }

            flipCard() {
                this.elements.flashcard.classList.toggle('flipped');
                this.isFlipped = !this.isFlipped;
            }

            nextCard() {
                if (this.filteredCards